---
phase: 04-transport-and-agent-integration
plan: "02"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified: []
autonomous: false
requirements:
  - FR-8.5
  - NFR-6.1
  - NFR-6.2

must_haves:
  truths:
    - "Claude Desktop or Cursor connects to the server using the MCP URL from OAuth and lists all 11 tools without error"
    - "An agent completes a multi-tool task (list_projects → get_project_tools → list_messages → get_message) against real Basecamp data"
    - "Two simultaneous users each see only their own Basecamp projects — no data crosses between sessions"
    - "TRANSPORT=stdio mode starts the server without OAuth, reads a token from env, and a tool call returns real Basecamp data"
  artifacts:
    - path: "src/server.ts"
      provides: "/mcp/:userToken route accepting agent connections"
      contains: "StreamableHTTPServerTransport"
    - path: "src/index.ts"
      provides: "TRANSPORT=stdio conditional entry point"
      contains: "TRANSPORT"
  key_links:
    - from: "Claude Desktop / Cursor MCP config"
      to: "POST /mcp/:userToken"
      via: "Agent sends initialize request to user's personal MCP URL"
      pattern: "mcp_url from OAuth callback"
    - from: "sessions Map"
      to: "basecampUserId per session"
      via: "Each session resolves to one user — verified by calling list_projects from two accounts simultaneously"
      pattern: "sessions.get(sessionId).userId"
---

<objective>
Human smoke test: verify that a real agent (Claude Desktop or Cursor) connects to the running server over Streamable HTTP, calls all 11 tools successfully against live Basecamp data, and that two simultaneous users cannot access each other's data. Also verify TRANSPORT=stdio mode works for local dev.

Purpose: End-to-end proof that the Phase 4 transport wiring is correct. This is the only way to confirm session isolation, real protocol handshake, and multi-tool chaining — none of these are verifiable by tsc or unit tests alone.

Output: No new files. Human confirmation that all four phase success criteria are met.
</objective>

<execution_context>
@/home/het/.claude/get-shit-done/workflows/execute-plan.md
@/home/het/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/04-transport-and-agent-integration/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start the server and run pre-flight checks</name>
  <files></files>
  <action>
Before handing off to the human smoke test, run automated checks to confirm the server starts cleanly and the /health and /mcp routes are accessible.

**Step 1 — Confirm build is clean:**

```bash
npx tsc --noEmit
```

Must exit 0 before proceeding.

**Step 2 — Start the server in the background:**

```bash
npm run dev &
sleep 2
```

Wait 2 seconds for Express to bind.

**Step 3 — Health check:**

```bash
curl -s http://localhost:3000/health
```

Expected: `{"status":"ok"}`

**Step 4 — Confirm an unknown userToken returns 401:**

```bash
curl -s -o /dev/null -w "%{http_code}" \
  -X POST http://localhost:3000/mcp/not-a-real-token \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"initialize","id":1,"params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1"}}}'
```

Expected output: `401`

**Step 5 — Confirm OAuth start is reachable:**

```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/oauth/start
```

Expected: `302` (redirect to Basecamp Launchpad)

**Step 6 — Check existing token in SQLite and read the stored mcp_token:**

```bash
sqlite3 tokens.db "SELECT basecamp_user_id, email, mcp_token FROM tokens LIMIT 3;"
```

If `mcp_token` column is NULL for existing rows (tokens stored before Phase 4), instruct the user to re-authenticate via /oauth/start to generate their mcp_token. If mcp_token IS populated, output it for the smoke test.

Stop the background server before handing off: `kill %1` or find and kill the tsx process.
  </action>
  <verify>
1. `npx tsc --noEmit` exits 0
2. `curl http://localhost:3000/health` returns `{"status":"ok"}`
3. POST to /mcp/not-a-real-token returns HTTP 401
4. GET /oauth/start returns HTTP 302
5. `sqlite3 tokens.db "SELECT mcp_token FROM tokens WHERE mcp_token IS NOT NULL LIMIT 1;"` returns a UUID (or user is instructed to re-auth first)
  </verify>
  <done>
Server starts cleanly. Health check passes. Unknown token returns 401. OAuth redirect works. mcp_token present in SQLite or user informed to re-auth.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Agent smoke test — connect Claude Desktop or Cursor, run multi-tool task, verify session isolation, verify stdio mode</name>
  <files></files>
  <action>
Human verification of four end-to-end scenarios that cannot be automated: agent connection via Streamable HTTP, multi-tool task against live Basecamp data, session isolation between two users, and TRANSPORT=stdio local dev mode.
  </action>
  <verify>
All five checks below must pass (check 4 may be skipped if only one Basecamp account is available):

1. OAuth callback returns mcp_url
2. Agent (Claude Desktop or Cursor) lists all 11 tools
3. Multi-tool task completes with real Basecamp data in markdown
4. Two sessions are isolated (each sees only its own user's projects)
5. TRANSPORT=stdio starts stdio mode, list_projects returns real data
  </verify>
  <done>
Human types "approved" or "approved no-second-user" confirming all applicable checks passed.
  </done>
  <what-built>
Streamable HTTP transport wired to the tool layer (Plan 04-01). Each authenticated user has a personal MCP URL (/mcp/:userToken). TRANSPORT=stdio conditional entry point for local dev.
  </what-built>
  <how-to-verify>
Run each check in order. Stop if any check fails and report the failure.

---

**CHECK 1: Fresh OAuth to get your personal MCP URL**

1. Start the server: `npm run dev`
2. Visit http://localhost:3000/oauth/start in a browser
3. Complete the Basecamp OAuth flow
4. The callback response JSON should include `"mcp_url": "http://localhost:3000/mcp/<uuid>"`
5. Copy that mcp_url — you will paste it into Claude Desktop or Cursor next

If mcp_url is missing from the response: Plan 04-01 Task 2 is incomplete. Stop and report.

---

**CHECK 2: Claude Desktop or Cursor connects and lists tools**

Configure your agent:

For Claude Desktop, add to `claude_desktop_config.json`:
```json
{
  "mcpServers": {
    "basecamp": {
      "url": "http://localhost:3000/mcp/<your-uuid-from-check-1>"
    }
  }
}
```

For Cursor, add the MCP URL in Settings > MCP > Add Server using the URL from check 1.

After connecting:
- The agent's tool list must show all 11 tools: `list_projects`, `get_project_tools`, `list_messages`, `get_message`, `list_todolists`, `list_todos`, `get_todo`, `list_documents`, `get_document`, `list_campfire_lines`, `list_attachments`
- No connection error should appear

If fewer than 11 tools appear or connection fails: note which tools are missing and report.

---

**CHECK 3: Multi-tool task against real Basecamp data**

In the agent, run a prompt like:
> "List my Basecamp projects, then find the message board for the first active project, list its messages, and get the content of the most recent message."

This exercises: `list_projects` → `get_project_tools` → `list_messages` → `get_message`

Expected: All four tool calls succeed. The final response includes message content in markdown (no raw HTML tags like `<p>` or `<div>`).

---

**CHECK 4: Session isolation with two users (if a second Basecamp account is available)**

If you have access to two separate Basecamp accounts:

1. Open a second browser / incognito window
2. Visit http://localhost:3000/oauth/start and authenticate with the second account
3. Note the second `mcp_url` from the callback response
4. Configure a second agent connection using the second mcp_url
5. Call `list_projects` from both agent sessions simultaneously (or sequentially)
6. Confirm each agent sees only its own user's projects — no cross-contamination

If only one Basecamp account is available: skip this check and note it in your response. Session isolation is structurally enforced by the sessions Map (each session's userId is set at initialize time and never changes), so a single-account test still confirms the wiring is correct.

---

**CHECK 5: TRANSPORT=stdio mode**

1. Stop the running server
2. Find your basecampUserId: `sqlite3 tokens.db "SELECT basecamp_user_id FROM tokens LIMIT 1;"`
3. Run: `BASECAMP_USER_ID=<your-id> npm run mcp`
4. The server should start without starting HTTP, printing to stderr: `Basecamp MCP server running in stdio mode for user <id>`
5. Open MCP Inspector: `npx @modelcontextprotocol/inspector`
6. Connect MCP Inspector to the stdio process
7. Call `list_projects` — should return real Basecamp projects

Expected: stdio mode starts, MCP Inspector lists 11 tools, `list_projects` returns real data.
  </how-to-verify>
  <resume-signal>
Type one of:
- "approved" — all 5 checks passed
- "approved no-second-user" — checks 1-3 and 5 passed; check 4 skipped (no second Basecamp account)
- Describe what failed (e.g. "check 2 failed: only 9 tools listed") so the executor can diagnose
  </resume-signal>
</task>

</tasks>

<verification>
Human confirms all applicable checks:
1. OAuth callback returns mcp_url (personal MCP URL issued)
2. Agent connects and lists all 11 tools (NFR-6.1 — Claude Desktop/Cursor compatible)
3. Multi-tool task (list_projects → get_project_tools → list_messages → get_message) completes against real Basecamp data (FR-8.5 success criterion 3)
4. Two simultaneous sessions see only their own data (NFR-6.1 session isolation) — or skipped with note if only one account available
5. TRANSPORT=stdio starts without HTTP, tools work via stdio (NFR-6.2)
</verification>

<success_criteria>
1. Claude Desktop or Cursor connects to /mcp/:userToken and lists all 11 tools — no connection errors (NFR-6.1)
2. Multi-tool chain list_projects → get_project_tools → list_messages → get_message returns real Basecamp data with markdown content (FR-8.5)
3. Two authenticated users' sessions are isolated — each agent sees only its own Basecamp account data (NFR-6.1 session isolation)
4. TRANSPORT=stdio starts the server in stdio mode, MCP Inspector connects, list_projects returns real data (NFR-6.2)
5. Phase 4 complete — all three requirements addressed: FR-8.5, NFR-6.1, NFR-6.2
</success_criteria>

<output>
After completion, create `.planning/phases/04-transport-and-agent-integration/04-02-SUMMARY.md`
</output>
